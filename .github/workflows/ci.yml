name: CI

on:
  push:
  pull_request:

jobs:
  contracts-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Contracts lint
        run: python3 ./scripts/validate_contracts.py --lint-only

  contracts-validate-strict:
    runs-on: ubuntu-latest
    needs: contracts-lint
    steps:
      - uses: actions/checkout@v4
      - name: Strict contracts validation
        run: python3 ./scripts/validate_contracts.py --strict

  policy-gates:
    runs-on: ubuntu-latest
    needs: contracts-validate-strict
    steps:
      - uses: actions/checkout@v4
      - name: Policy gates
        run: python3 ./scripts/validate_contracts.py --policy-only

  regression-pack:
    runs-on: ubuntu-latest
    needs: contracts-validate-strict
    steps:
      - uses: actions/checkout@v4
      - name: Regression pack
        run: python3 ./scripts/validate_contracts.py --regression-pack

  json-render-smoke:
    runs-on: ubuntu-latest
    needs: contracts-validate-strict
    steps:
      - uses: actions/checkout@v4
      - name: json-render smoke
        run: python3 ./scripts/json_render_smoke.py --pass-fixture ./examples/contracts/pass/routing_decision_packet.json --fail-fixture ./examples/contracts/fail/routing_decision_packet_chosen_model_missing_from_candidates.json --rendered-output /tmp/json_render_smoke.html

  checkpoint-contracts:
    runs-on: ubuntu-latest
    needs: contracts-validate-strict
    steps:
      - uses: actions/checkout@v4
      - name: Checkpoint contracts
        run: python3 ./scripts/validate_contracts.py --strict

  checkpoint-regression-pack:
    runs-on: ubuntu-latest
    needs: regression-pack
    steps:
      - uses: actions/checkout@v4
      - name: Checkpoint regression pack
        run: python3 ./scripts/validate_contracts.py --regression-pack

  checkpoint-go-no-go-script:
    runs-on: ubuntu-latest
    needs:
      - checkpoint-contracts
      - checkpoint-regression-pack
    steps:
      - uses: actions/checkout@v4
      - name: Checkpoint dry-run script
        run: python3 ./scripts/run_harness_checkpoint.py --dry-run-fixtures

  docs-consistency:
    runs-on: ubuntu-latest
    needs:
      - policy-gates
      - regression-pack
      - checkpoint-go-no-go-script
    steps:
      - uses: actions/checkout@v4
      - name: Docs consistency
        run: python3 ./scripts/validate_contracts.py --docs-only
